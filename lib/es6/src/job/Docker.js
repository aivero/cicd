// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Env from "../std/Env.js";
import * as Dict from "../std/Dict.js";
import * as Hash from "../std/Hash.js";
import * as Path from "../std/Path.js";
import * as Task from "../std/Task.js";
import * as Yaml from "../std/Yaml.js";
import * as Path$1 from "path";
import * as $$Array from "../std/Array.js";
import * as Tuple from "../std/Tuple.js";
import * as Result from "../std/Result.js";
import * as $$String from "../std/String.js";

function hashN(__x) {
  return Hash.hashN(__x, 3);
}

function getName(file, folder) {
  var name = $$String.split(file, ".")[0];
  if (name !== undefined && name !== "Dockerfile") {
    return name;
  } else {
    return Path$1.basename(folder);
  }
}

function getInstances($$int) {
  var file = Yaml.get($$int.modeInt, "file");
  var file$1;
  file$1 = typeof file === "number" || file.TAG !== /* String */0 ? undefined : file._0;
  var hash = Hash.hashN($$int, 3);
  if (file$1 !== undefined) {
    return [{
              name: $$int.name,
              version: $$int.version,
              tagName: $$int.name,
              file: file$1,
              folder: $$int.folder,
              tags: $$int.tags,
              needs: $$int.needs,
              hash: hash
            }];
  } else {
    return $$Array.map($$Array.filter(Path.read($$int.folder), (function (file) {
                      return $$String.includes(file.name, "Dockerfile");
                    })), (function (file) {
                  var name = $$String.split(file.name, ".")[0];
                  var tmp;
                  tmp = name !== undefined && name !== "Dockerfile" ? name : $$int.name;
                  return {
                          name: tmp,
                          version: $$int.version,
                          tagName: $$int.name,
                          file: file.name,
                          folder: $$int.folder,
                          tags: ["gitlab-org-docker"],
                          needs: $$int.needs,
                          hash: hash
                        };
                }));
  }
}

function getJob(param) {
  var hash = param.hash;
  var needs = param.needs;
  var tags = param.tags;
  var folder = param.folder;
  var file = param.file;
  var tagName = param.tagName;
  var version = param.version;
  var name = param.name;
  return Result.map(Result.seq4(Tuple.map4([
                      "DOCKER_USER",
                      "DOCKER_PASSWORD",
                      "DOCKER_REGISTRY",
                      "DOCKER_PREFIX"
                    ], Env.getError)), (function (param) {
                var registry = param[2];
                var dockerTag = registry + param[3] + tagName;
                var match = $$String.match(version, /^[0-9a-f]{40}$/);
                var branchTagUpload = match !== undefined;
                var script = $$Array.concat([
                      "docker login --username " + param[0] + " --password " + param[1] + " " + registry,
                      "docker build " + folder + " --file " + Path$1.join(folder, file) + " --tag " + dockerTag + ":" + version,
                      "docker push " + dockerTag + ":" + version
                    ], branchTagUpload ? [
                        "docker tag " + dockerTag + ":" + version + " " + dockerTag + ":$CI_COMMIT_REF_NAME",
                        "docker push " + dockerTag + ":$CI_COMMIT_REF_NAME"
                      ] : []);
                return Dict.to(name + "/" + version + "@" + hash, {
                            extends: undefined,
                            variables: undefined,
                            image: "docker:19.03.12",
                            tags: tags,
                            script: script,
                            needs: needs,
                            services: ["docker:19.03.12-dind"],
                            cache: undefined
                          });
              }));
}

function getJobs(ints) {
  return Task.fromResult(Result.seq($$Array.flatMap($$Array.filter(ints, (function ($$int) {
                            return $$int.mode === "docker";
                          })), (function ($$int) {
                        var ints = getInstances($$int);
                        return $$Array.concat($$Array.map(ints, getJob), [{
                                      TAG: /* Ok */0,
                                      _0: Dict.to($$int.name + "/" + $$int.version, {
                                            extends: undefined,
                                            variables: undefined,
                                            image: undefined,
                                            tags: undefined,
                                            script: ["echo"],
                                            needs: $$Array.map(ints, (function ($$int) {
                                                    return $$int.name + "/" + $$int.version + "@" + $$int.hash;
                                                  })),
                                            services: undefined,
                                            cache: undefined
                                          })
                                    }]);
                      }))));
}

var hashLength = 3;

export {
  hashLength ,
  hashN ,
  getName ,
  getInstances ,
  getJob ,
  getJobs ,
  
}
/* Hash Not a pure module */
